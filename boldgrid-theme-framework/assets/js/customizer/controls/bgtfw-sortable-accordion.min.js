import camelCase from"lodash.camelcase";import kebabCase from"lodash.kebabcase";import startCase from"lodash.startcase";const api=wp.customize;export default{ready(){this.setSelectQueue(),this.setSortable(),this.addSortables(),this.addTypes(),this.addRepeaterControls(),this.updateTitles(),this.updateAddTypes(),this.addEvents(),this.addUids(),this._toggleSticky()},setSelectQueue(){return this.selectQueue=0},setSortable(){return this.sortable=this.container.find(`#sortable-${this.id}`)},addSortables(){this.addPrimarySortables(),this.addRepeaterSortables()},addPrimarySortables(){this.sortable.accordion({header:"> .sortable-wrapper > .sortable-title",heightStyle:"content",collapsible:!0}).sortable({update:this.updateValues.bind(this)}).disableSelection()},addRepeaterSortables(){this.container.find(".connected-sortable").accordion({header:".repeater-handle",heightStyle:"content",collapsible:!0}).sortable({update:this.updateValues.bind(this)}).disableSelection()},addEvents(){api.bind("ready",()=>{$(api.OuterSection.prototype.containerParent).on("bgtfw-menu-dropdown-select",_.after(this.getConnectedMenus().length,this.updateConnectedSelects(!0))),this.sortable.on("click",".bgtfw-sortable:not(.disabled)",t=>this._addItem(t)).on("click",".bgtfw-container-control > .bgtfw-sortable-control:not(.selected), .repeater-control.align .direction:not(.selected), .repeater-control.sticky .bgtfw-sortable-control:not(.selected)",t=>this._select(t)).on("click",".dashicons-trash",t=>this._deleteItem(t)).on("change",".repeater-control.menu-select",t=>this._updateMenuSelect(t)).on("click",".repeater-control.align .direction:not(.selected)",t=>this._updateAlignment(t)).on("click",".bgtfw-container-control > .bgtfw-sortable-control:not(.selected)",()=>this._updateContainer()).on("change",".repeater-control.attribution",t=>this._updateAttribution(t)),$(`#sortable-${this.id}-add-section`).on("click",t=>this.addSection(t)),api("bgtfw_fixed_header","bgtfw_header_layout_position","custom_logo",(...t)=>{t.map(t=>{t.bind(()=>this._toggleSticky())})}),api.previewer.bind("ready",()=>{this.sortable.on("click",".repeater-control.sticky .bgtfw-sortable-control:not(.selected)",t=>this._updateSelector(t))})})},addUids(){this.container[0].querySelectorAll(".repeater.ui-sortable-handle").forEach(t=>{(_.isEmpty(t.dataset)||_.isUndefined(t.dataset.uid))&&(t.dataset.uid=_.uniqueId(this.params.location.charAt(0).toString()))})},_updateSelector(t){let e=t.currentTarget,s=$(e).closest(".repeater")[0],i={display:e.dataset.sticky,selector:this.getItemSelector(s.dataset)},a=JSON.parse(decodeURIComponent(s.dataset.sticky));a[_.findIndex(a,{selector:i.selector})]=_.extend(_.findWhere(a,{selector:i.selector}),i),s.dataset.sticky=encodeURIComponent(JSON.stringify(a)),this.updateValues()},getItemSelector(t){let e=t.selector;return"menu"===t.key&&(e=this.getMenuSelector(t.type)),"sidebar"===t.key&&(e=this.getSidebarSelector(t.type)),e},_toggleSticky(){"header"===this.params.location&&("header-top"===api("bgtfw_header_layout_position")()&&!0===api("bgtfw_fixed_header")()?(api.control("bgtfw_fixed_header").container.find(".customize-control-description").show(),this.container.find(".repeater-control.sticky").removeClass("hidden"),_.isEmpty(api("custom_logo")())&&this.container.find('.repeater-control[data-selector=".custom-logo"]').addClass("hidden")):(api.control("bgtfw_fixed_header").container.find(".customize-control-description").hide(),this.container.find(".repeater-control.sticky").addClass("hidden")))},addSection(t){t.preventDefault(),this.container.find(".connected-sortable").sortable("destroy");let e=this.sortable.find(".sortable-wrapper"),s=e.last().clone(!0);s.attr("id",`sortable-${e.length}-wrapper`),s.find(".connected-sortable").attr("id",`sortable-${this.id}-${e.length}`),s.find(".connected-sortable li").remove(),s.appendTo(this.sortable),this.addRepeaterSortables(),this.refreshItems(),this.updateValues()},_deleteItem(t){let e=$(t.currentTarget).closest(".ui-sortable-handle"),s=0;_.isEmpty(e[0].dataset)?e[0].querySelectorAll(".repeater.ui-sortable-handle").forEach(t=>{"menu"===t.dataset.key&&s++}):"menu"===e[0].dataset.key&&s++,e.remove(),this.updateValues(),0!==s&&this.updateConnectedSelects()},_updateMenuSelect(t){let e=t.currentTarget;$(e).closest(".repeater")[0].dataset.type=e.value,this.updateValues(),this.updateConnectedSelects()},updateConnectedSelects(t){let e,s,i=_.isUndefined(t),a=[];i||(this.getLastConnected().selectQueue+=1),(i||this.getLastConnected().selectQueue>=this.getConnectedControls().length)&&(s=this.getConnectedMenus(),_.each(this.getConnectedControls(),t=>{e=this.id===t.id?this:api.control(t.id),_.isUndefined(e)||a.push(e.selector)}),a=a.map(t=>`${api.OuterSection.prototype.containerParent} ${t} .repeater-control.menu-select option`).join(", "),document.querySelectorAll(a).forEach(t=>{let e=$(t).closest(".repeater")[0].dataset.type;t.disabled=!(!s.includes(t.value)||e===t.value)}),this.selectQueue=0)},_updateAlignment(t){let e=t.currentTarget,s=$(e).closest(".repeater")[0],i=e.className.replace(/direction|selected|\s/g,"");s.dataset.align=i,this.updateValues()},_updateContainer(){this.updateValues()},isJSON(t){try{let e=JSON.parse(decodeURIComponent(t));if(e&&_.isObject(e))return!0}catch(t){return!1}return!1},addRepeaterControls(t=!1){let e=this.sortable.find(".repeater");_.after(this.getUsedMenuActions().length,()=>$(api.OuterSection.prototype.containerParent).trigger("bgtfw-menu-dropdown-select"));_.each(e,e=>{let s,i=e.querySelector(".repeater-accordion-content"),a=this.params.items[e.dataset.key].controls||{};_.each(a,(a,n)=>{e.querySelector(`.repeater-control.${kebabCase(n)}`)||(s=e.dataset[n]||a.default||e.dataset.type,s=this.isJSON(s)?JSON.parse(decodeURIComponent(s)):s,i.innerHTML+=this[camelCase(`Get ${n} Markup`)](s),"menu-select"===n&&t&&this.updateConnectedSelects())})})},getStickyMarkup(t){let e="";return _.each(t,t=>{let s=`<div class="repeater-control sticky" data-selector="${t.selector}">\n\t\t\t\t<div class="repeater-control-title">${t.title}</div>\n\t\t\t\t<div class="control-wrapper">\n\t\t\t\t\t<div class="bgtfw-sortable-control sticky-show" data-sticky="show">\n\t\t\t\t\t\t<span class="dashicons dashicons-visibility"></span><span>Show</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bgtfw-sortable-control sticky-hide" data-sticky="hide">\n\t\t\t\t\t\t<span class="dashicons dashicons-hidden"></span><span>Hide</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>`;s=s.replace(`bgtfw-sortable-control sticky-${t.display}`,`bgtfw-sortable-control sticky-${t.display} selected`),e+=s}),e},_updateAttribution(t){api(t.currentTarget.dataset.attribution).set(t.currentTarget.checked)},getAttributionMarkup(){let t='<div class="repeater-control attribution"><ul>';return _.each(this.getAttributionSettings(),e=>{let s=_.uniqueId(`${e.id}_`),i=api(e.id)()?"checked":"";t+=`<li>\n\t\t\t\t<input id="${s}" class="attribution-link" type="checkbox" data-attribution="${e.id}" ${i}>\n\t\t\t\t<label for="${s}">${startCase(e.id)}</label>\n\t\t\t</li>`}),t+="</ul></div>"},getAlignMarkup(t){let e='\n\t\t<div class="repeater-control align">\n\t\t\t<div class="align-wrapper">\n\t\t\t\t<div class="repeater-control-title">Alignment</div>\n\t\t\t\t<div class="direction nw">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-up"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction n">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-up"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction ne">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-up"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction w">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-left"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction c">\n\t\t\t\t\t<span class="dashicons dashicons-marker"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction e">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-right"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction sw">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-down"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction s">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-down"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction se">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-down"></span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>';return e=e.replace(`"direction ${t}"`,`"direction ${t} selected"`)},getSidebarEditMarkup:t=>`<div class="repeater-control sidebar-edit">\n\t\t\t<p class="repeater-control-description">Edit sidebar widgets and appearance in "Widgets" section.</p>\n\t\t\t<a class="button-primary" href="#" onclick="event.preventDefault(); wp.customize.section( 'sidebar-widgets-${t.replace("bgtfw_sidebar_","")}' ).focus();"><i class="dashicons dashicons-edit"></i>Edit Sidebar</a>\n\t\t</div>`,getMenuSelectMarkup(t){let e,s='<select class="repeater-control menu-select">';return _.each(window._wpCustomizeNavMenusSettings.locationSlugMappedToName,(i,a)=>{s+=`<option value="boldgrid_menu_${a}"${e=`boldgrid_menu_${a}`===t?"selected":""}>${i}</option>`}),s+="</select>"},updateValues(){let t=this.getValues();this.setting.set(t),this.updateTitles(),this.updateAddTypes()},getValues(){let t=[];return _.each(this.container.find(".connected-sortable"),(e,s)=>{let i=$(e).find(".repeater").map((t,e)=>Object.assign({},_.mapObject(e.dataset,t=>this.isJSON(t)?JSON.parse(decodeURIComponent(t)):t))).toArray();t[s]={container:this.getContainer(e),items:i}}),t},getContainer:t=>t.previousElementSibling.querySelector(".selected").dataset.container,_select(t){let e=$(t.currentTarget);e.siblings().removeClass("selected"),e.addClass("selected")},_addItem(t){let e=t.currentTarget,s=e.dataset,i=e.parentElement.previousElementSibling;i.innerHTML+=this.getMarkup(s),_.each(this.params.items[e.dataset.key].controls,(t,e)=>{_.isUndefined(t.default)||(_.isString(t.default)||(t.default=encodeURIComponent(JSON.stringify(t.default))),i.lastChild.dataset[e]=t.default)}),_.isUndefined(i.lastChild.dataset.uid)&&(i.lastChild.dataset.uid=_.uniqueId(this.params.location.charAt(0).toString())),this.addRepeaterControls(!0),this.refreshItems(),this.updateValues()},updateTitles(){_.each(this.sortable.sortable("instance").items,t=>{let e=t.item[0],s=e.querySelector(".title"),i=[];e.querySelectorAll(".repeater-title").forEach(t=>i.push(t.textContent)),i=i.join('<span class="title-divider">&#9679;</span>'),_.isEmpty(i)&&(s.classList.add("title-empty"),i="<em>Empty Section</em>"),s.classList.remove("title-empty"),s.innerHTML=i})},refreshItems(t=["sortable","accordion"]){_.each(t,t=>{this.sortable[t]("refresh"),this.container.find(".connected-sortable")[t]("refresh")})},refreshSortables(){this.sortable.sortable("refresh"),this.container.find(".connected-sortable").sortable("refresh")},refreshAccordions(){this.sortable.accordion("refresh"),this.container.find(".connected-sortable").accordion("refresh")},getMarkup(t){return`<li class="repeater" ${Object.entries(t).map(t=>(_.isString(t[1])||(t[1]=encodeURIComponent(JSON.stringify(t[1]))),`data-${t[0]}="${t[1]}"`)).join(" ")}>\n\t\t\t<div class="repeater-input">\n\t\t\t\t<div class="repeater-handle">\n\t\t\t\t\t<div class="sortable-title">\n\t\t\t\t\t\t<span class="repeater-title"><i class="${this.params.items[t.key].icon}"></i>${this.params.items[t.key].title}</span><span class="dashicons dashicons-trash"></span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="repeater-accordion-content-wrapper">\n\t\t\t\t\t<div class="repeater-accordion-content"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</li>`},updateAddTypes(){this.sortable[0].querySelectorAll(".bgtfw-sortable").forEach(t=>{this.getItem(t.dataset.key)?(t.classList.remove("disabled"),t.dataset.type=this.getItem(t.dataset.key)):t.classList.add("disabled")})},addTypes(){this.container[0].querySelectorAll(".sortable-actions").forEach(t=>{_.each(this.params.items,(e,s)=>{t.innerHTML+=this.getAddTypeMarkup(e,s)})})},getMenuSelector:t=>"#"+t.replace("boldgrid_menu_",""),getSidebarSelector:t=>"#"+t.replace("bgtfw_sidebar_",""),getAddTypeMarkup:(t,e)=>`<span class="bgtfw-sortable ${e}" data-key="${e}" aria-label="Add ${t.title}"><i class="fa fa-plus"></i>${t.title}</span>`,getCurrentItems(){return _.map(_.flatten(_.map(this.setting.get(),t=>_.values(t.items))),t=>t.type)},getAllSidebarLocations:()=>_.pluck(window._wpCustomizeWidgetsSettings.registeredSidebars,"id"),getAllSidebarActions(){return this.getAllSidebarLocations().map(t=>`bgtfw_sidebar_${t}`)},getFilteredSidebarActions(){return _.filter(this.getAllSidebarActions(),t=>t.includes(this.params.location))},getUsedSidebarActions(){return _.filter(this.getCurrentItems(),t=>t.includes("bgtfw_sidebar"))},getAvailableSidebars(){return _.difference(this.getFilteredSidebarActions(),this.getUsedSidebarActions())},getNextAvailableSidebar(){return _.first(this.getAvailableSidebars())},getNextAvailableAttribution(){return this.getCurrentItems().includes("boldgrid_display_attribution_links")?null:"boldgrid_display_attribution_links"},getAllMenuActions:()=>Object.keys(window._wpCustomizeNavMenusSettings.locationSlugMappedToName).map(t=>`boldgrid_menu_${t}`),getUsedMenuActions(){return _.filter(this.getCurrentItems(),t=>t.includes("boldgrid_menu"))},getAvailableMenus(){return _.difference(this.getAllMenuActions(),this.getConnectedMenus())},getNextAvailableMenu(){return _.first(this.getAvailableMenus())},getItem(t){switch(t){case"menu":t=this.getNextAvailableMenu();break;case"sidebar":t=this.getNextAvailableSidebar();break;case"branding":t="boldgrid_site_identity";break;case"attribution":t=this.getNextAvailableAttribution()}return t},getAttributionSettings:()=>_.filter(_.mapObject(window._wpCustomizeSettings.settings,(t,e)=>_.extend(t,{id:e})),t=>t.id.includes("hide_")&&t.id.includes("_attribution")),getConnectedControls(){return _.filter(window._wpCustomizeSettings.controls,{type:this.params.type})},getConnectedItems(){return _.flatten([].concat(_.map(this.getConnectedControls(),t=>this.id===t.id?this.getCurrentItems():_.isUndefined(api.control(t.id))?[]:api.control(t.id).getCurrentItems())))},getConnectedMenus(){return _.filter(this.getConnectedItems(),t=>t.includes("boldgrid_menu"))},getLastConnected(){let t=_.last(this.getConnectedControls()).id;return _.isUndefined(api.control(t))?this:api.control(t)}};