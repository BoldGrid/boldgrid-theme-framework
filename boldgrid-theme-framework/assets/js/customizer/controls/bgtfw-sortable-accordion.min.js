import camelCase from"lodash.camelcase";import kebabCase from"lodash.kebabcase";import startCase from"lodash.startcase";import lowerCase from"lodash.lowercase";const api=wp.customize;export default{ready(){this.uids=[],this.setSelectQueue(),this.setSortable(),this.addSortables(),this.addTypes(),this.addRepeaterControls(),this.updateTitles(),this.updateAddTypes(),this.addEvents(),this.addUids()},setSelectQueue(){return this.selectQueue=0},setSortable(){return this.sortable=this.container.find(`#sortable-${this.id}`)},addSortables(){this.addPrimarySortables(),this.addRepeaterSortables()},addPrimarySortables(){this.sortable.accordion({header:"> .sortable-wrapper > .sortable-title",heightStyle:"content",collapsible:!0}).sortable({update:this.updateValues.bind(this)}).disableSelection()},addRepeaterSortables(){this.container.find(".connected-sortable").accordion({header:".repeater-handle",heightStyle:"content",collapsible:!0}).sortable({update:this.updateValues.bind(this)}).disableSelection()},addEvents(){api.bind("ready",()=>{$(api.OuterSection.prototype.containerParent).on("bgtfw-menu-dropdown-select",_.after(this.getConnectedMenus().length,this.updateConnectedSelects(!0))),this.sortable.on("click",".bgtfw-sortable:not(.disabled)",t=>this._addItem(t)).on("click",".bgtfw-container-control > .bgtfw-sortable-control:not(.selected), .repeater-control.align .direction:not(.selected)",t=>this._select(t)).on("click",".dashicons-trash",t=>this._deleteItem(t)).on("change",".repeater-control.menu-select",t=>this._updateMenuSelect(t)).on("click",".repeater-control.align .direction:not(.selected)",t=>this._updateAlignment(t)).on("click",".bgtfw-container-control > .bgtfw-sortable-control:not(.selected)",()=>this._updateContainer()).on("change",".repeater-control.attribution .attribution-link",t=>this._updateAttribution(t)).on("change",".display-control",t=>this._updateDisplay(t)),$(`#sortable-${this.id}-add-section`).on("click",t=>this.addSection(t)),api("bgtfw_fixed_header","bgtfw_header_layout_position","custom_logo",(...t)=>{t.map(t=>{t.bind(()=>this._toggleSticky())})}),api.previewer.bind("ready",()=>{this._toggleSticky(),this.sortable.on("click",".repeater-control.sticky .bgtfw-sortable-control:not(.selected)",t=>this._updateSelector(t))}),api("custom_logo",t=>t.bind(t=>this._toggleLogo(t)))})},_toggleLogo(t){this.container[0].querySelectorAll('[data-selector=".custom-logo"]').forEach(e=>{e.classList.toggle("hidden",_.isEmpty(t)&&!_.isNumber(t))})},addUids(){this.container[0].querySelectorAll(".repeater.ui-sortable-handle").forEach(t=>{if(_.isEmpty(t.dataset)||_.isUndefined(t.dataset.uid)){let e=_.uniqueId(this.params.location.charAt(0).toString());for(;this.uids.includes(e);)e=_.uniqueId(this.params.location.charAt(0).toString());this.uids.push(e),t.dataset.uid=e}})},_updateDisplay(t){let e=t.currentTarget;e.dataset.display=e.checked?"show":"hide";let i=$(e).closest(".repeater")[0],s={display:e.dataset.display,selector:e.dataset.selector},a=JSON.parse(decodeURIComponent(i.dataset.display));a[_.findIndex(a,{selector:s.selector})]=_.extend(_.findWhere(a,{selector:s.selector}),s),i.dataset.display=encodeURIComponent(JSON.stringify(a)),this.updateValues()},getItemSelector(t){let e=t.selector;return"menu"===t.key&&(e=this.getMenuSelector(t.type)),"sidebar"===t.key&&(e=this.getSidebarSelector(t.type)),e},_toggleSticky(){"sticky-header"===this.params.location&&("header-top"===api("bgtfw_header_layout_position")()&&!0===api("bgtfw_fixed_header")()?(api.control("bgtfw_fixed_header").container.find(".customize-control-description").show(),this.active.set(!0)):(api.control("bgtfw_fixed_header").container.find(".customize-control-description").hide(),this.active.set(!1)))},addSection(t){t.preventDefault();let e=this.container.find(".connected-sortable");e.sortable("destroy"),e.accordion("destroy");let i,s=this.sortable.find(".sortable-wrapper");s.length?((i=s.last().clone(!0)).attr("id",`sortable-${s.length}-wrapper`),i.find(".connected-sortable").attr("id",`sortable-${this.id}-${s.length}`),i.find(".connected-sortable li").remove(),i.appendTo(this.sortable)):(i=`\n\t\t\t<div id="sortable-0-wrapper" class="sortable-wrapper ui-sortable-handle">\n\t\t\t\t<span class="sortable-title ui-accordion-header ui-state-default ui-accordion-header-active ui-state-active ui-corner-top ui-accordion-icons" role="tab" id="ui-id-17" aria-controls="ui-id-18" aria-selected="true" aria-expanded="true" tabindex="0"><span class="ui-accordion-header-icon ui-icon ui-icon-triangle-1-s"></span><span class="title"><em>Empty Section</em></span><span class="dashicons dashicons-trash"></span></span>\n\t\t\t\t<div class="sortable-accordion-content ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active" id="ui-id-18" aria-labelledby="ui-id-17" role="tabpanel" aria-hidden="false" style="display: block;">\n\t\t\t\t\t<div class="sortable-section-controls">\n\t\t\t\t\t\t<div class="bgtfw-container-control">\n\t\t\t\t\t\t\t<div class="bgtfw-sortable-control container selected" data-container="container">\n\t\t\t\t\t\t\t\t<span class="bgtfw-icon icon-layout-container"></span>\n\t\t\t\t\t\t\t\t<span>Container</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="bgtfw-sortable-control full-screen" data-container="full-width">\n\t\t\t\t\t\t\t\t<span class="bgtfw-icon icon-layout-full-screen"></span>\n\t\t\t\t\t\t\t\t<span>Full Width</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<ul id="sortable-${this.id}-0" class="connected-sortable ui-accordion ui-widget ui-helper-reset ui-sortable" role="tablist">\n\t\t\t\t\t</ul>\n\t\t\t\t\t<div class="sortable-actions"></div>\n\t\t\t\t</div>\n\t\t\t</div>`,document.getElementById(`sortable-${this.id}`).innerHTML=i,this.addTypes()),this.addRepeaterSortables(),this.refreshItems(),this.updateValues()},_deleteItem(t){t.preventDefault();let e=$(t.currentTarget).closest(".ui-sortable-handle"),i=0;_.isEmpty(e[0].dataset)?e[0].querySelectorAll(".repeater.ui-sortable-handle").forEach(t=>{"menu"===t.dataset.key&&i++}):"menu"===e[0].dataset.key&&i++,e.remove(),this.updateValues(),0!==i&&this.updateConnectedSelects()},_updateMenuSelect(t){let e=t.currentTarget;$(e).closest(".repeater")[0].dataset.type=e.value,this.updateValues(),this.updateConnectedSelects()},updateConnectedSelects(t){let e,i,s=_.isUndefined(t),a=[];s||(this.getLastConnected().selectQueue+=1),(s||this.getLastConnected().selectQueue>=this.getConnectedControls().length)&&(i=this.getConnectedMenus(),_.each(this.getConnectedControls(),t=>{e=this.id===t.id?this:api.control(t.id),_.isUndefined(e)||a.push(e.selector)}),a=a.map(t=>`${api.OuterSection.prototype.containerParent} ${t} .repeater-control.menu-select option`).join(", "),document.querySelectorAll(a).forEach(t=>{let e=$(t).closest(".repeater")[0].dataset.type;t.disabled=!(!i.includes(t.value)||e===t.value)}),this.selectQueue=0)},_updateAlignment(t){let e=t.currentTarget,i=$(e).closest(".repeater")[0],s=e.className.replace(/direction|selected|\s/g,"");i.dataset.align=s,this.updateValues()},_updateContainer(){this.updateValues()},isJSON(t){try{let e=JSON.parse(decodeURIComponent(t));if(e&&_.isObject(e))return!0}catch(t){return!1}return!1},addRepeaterControls(t=!1){let e=this.sortable.find(".repeater");_.after(this.getUsedMenuActions().length,()=>$(api.OuterSection.prototype.containerParent).trigger("bgtfw-menu-dropdown-select"));_.each(e,e=>{let i,s=e.querySelector(".repeater-accordion-content"),a=this.params.items[e.dataset.key].controls||{};_.each(a,(a,n)=>{e.querySelector(`.repeater-control.${kebabCase(n)}`)||(i=e.dataset[n]||a.default||e.dataset.type,i=this.isJSON(i)?JSON.parse(decodeURIComponent(i)):i,s.innerHTML+=this[camelCase(`Get ${n} Markup`)](i),"menu-select"===n&&t&&this.updateConnectedSelects())})})},getDisplayMarkup(t){let e='\n\t\t<div class="repeater-control display">\n\t\t\t<div class="repeater-control-title">Display</div>\n\t\t\t<div class="repeater-control-nested">\n\t\t\t\t<div class="control-wrapper">\n\t\t\t\t\t<ul>';return _.each(t,t=>{let i="display-control",s=_.uniqueId(`${this.params.location}-${lowerCase(t.title)}-`),a="hide"===t.display?"":"checked",n=api("custom_logo")();".custom-logo"===t.selector&&_.isEmpty(n)&&!_.isNumber(n)&&(i+=" hidden"),e+=`\n\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t<input id="${s}" class="${i}" type="checkbox" data-display="${t.display}" data-selector="${t.selector}" ${a}>\n\t\t\t\t\t\t\t<label for="${s}">${t.title}</label>\n\t\t\t\t\t\t</li>`}),e+="</ul>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>"},_updateAttribution(t){api(t.currentTarget.dataset.attribution).set(t.currentTarget.checked)},getAttributionMarkup(){let t='<div class="repeater-control attribution"><ul>';return _.each(this.getAttributionSettings(),e=>{let i=_.uniqueId(`${e.id}_`),s=api(e.id)()?"checked":"";t+=`<li>\n\t\t\t\t<input id="${i}" class="attribution-link" type="checkbox" data-attribution="${e.id}" ${s}>\n\t\t\t\t<label for="${i}">${startCase(e.id).replace("g","G").replace("p","P")}</label>\n\t\t\t</li>`}),t+="</ul></div>"},getAlignMarkup(t){let e='\n\t\t<div class="repeater-control align">\n\t\t\t<div class="align-wrapper">\n\t\t\t\t<div class="repeater-control-title">Alignment</div>\n\t\t\t\t<div class="direction nw">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-up"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction n">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-up"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction ne">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-up"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction w">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-left"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction c">\n\t\t\t\t\t<span class="dashicons dashicons-marker"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction e">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-right"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction sw">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-down"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction s">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-down"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="direction se">\n\t\t\t\t\t<span class="dashicons dashicons-arrow-down"></span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>';return e=e.replace(`"direction ${t}"`,`"direction ${t} selected"`)},getSidebarEditMarkup:t=>`<div class="repeater-control sidebar-edit">\n\t\t\t<p class="repeater-control-description">Edit sidebar widgets and appearance in "Widgets" section.</p>\n\t\t\t<a class="button-primary" href="#" onclick="event.preventDefault(); wp.customize.section( 'sidebar-widgets-${t.replace("bgtfw_sidebar_","")}' ).focus();"><i class="dashicons dashicons-edit"></i>Edit Sidebar</a>\n\t\t</div>`,getMenuSelectMarkup(t){let e,i='<select class="repeater-control menu-select">';return _.each(window._wpCustomizeNavMenusSettings.locationSlugMappedToName,(s,a)=>{"sticky-header"!==this.params.location&&a.includes("sticky")||("sticky-header"!==this.params.location||a.includes("sticky"))&&(i+=`<option value="boldgrid_menu_${a}"${e=`boldgrid_menu_${a}`===t?"selected":""}>${s}</option>`)}),i+="</select>"},updateValues(){let t=this.getValues();this.setting.set(t),this.updateTitles(),this.updateAddTypes()},getValues(){let t=[];return _.each(this.container.find(".connected-sortable"),(e,i)=>{let s=$(e).find(".repeater").map((t,e)=>Object.assign({},_.mapObject(e.dataset,t=>this.isJSON(t)?JSON.parse(decodeURIComponent(t)):t))).toArray();t[i]={container:this.getContainer(e),items:s}}),t},getContainer:t=>t.previousElementSibling.querySelector(".selected").dataset.container,_select(t){let e=$(t.currentTarget);e.siblings().removeClass("selected"),e.addClass("selected")},_addItem(t){let e=t.currentTarget,i=e.dataset,s=e.parentElement.previousElementSibling;s.innerHTML+=this.getMarkup(i),_.each(this.params.items[e.dataset.key].controls,(t,e)=>{_.isUndefined(t.default)||(_.isString(t.default)||(t.default=encodeURIComponent(JSON.stringify(t.default))),s.lastChild.dataset[e]=t.default)}),_.isUndefined(s.lastChild.dataset.uid)&&(s.lastChild.dataset.uid=_.uniqueId(this.params.location.charAt(0).toString())),this.addRepeaterControls(!0),this.refreshItems(),this.updateValues()},updateTitles(){_.each(this.sortable.sortable("instance").items,t=>{let e=t.item[0],i=e.querySelector(".title"),s=[];e.querySelectorAll(".repeater-title").forEach(t=>s.push(t.textContent)),s=s.join('<span class="title-divider">&#9679;</span>'),_.isEmpty(s)&&(i.classList.add("title-empty"),s="<em>Empty Section</em>"),i.classList.remove("title-empty"),i.innerHTML=s})},refreshItems(t=["sortable","accordion"]){_.each(t,t=>{this.sortable[t]("refresh"),this.container.find(".connected-sortable")[t]("refresh")})},refreshSortables(){this.sortable.sortable("refresh"),this.container.find(".connected-sortable").sortable("refresh")},refreshAccordions(){this.sortable.accordion("refresh"),this.container.find(".connected-sortable").accordion("refresh")},getMarkup(t){return`<li class="repeater" ${Object.entries(t).map(t=>(_.isString(t[1])||(t[1]=encodeURIComponent(JSON.stringify(t[1]))),`data-${t[0]}="${t[1]}"`)).join(" ")}>\n\t\t\t<div class="repeater-input">\n\t\t\t\t<div class="repeater-handle">\n\t\t\t\t\t<div class="sortable-title">\n\t\t\t\t\t\t<span class="repeater-title"><i class="${this.params.items[t.key].icon}"></i>${this.params.items[t.key].title}</span><span class="dashicons dashicons-trash"></span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="repeater-accordion-content-wrapper">\n\t\t\t\t\t<div class="repeater-accordion-content"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</li>`},updateAddTypes(){this.sortable[0].querySelectorAll(".bgtfw-sortable").forEach(t=>{this.getItem(t.dataset.key)?(t.classList.remove("disabled"),t.dataset.type=this.getItem(t.dataset.key)):t.classList.add("disabled")})},addTypes(){this.container[0].querySelectorAll(".sortable-actions").forEach(t=>{_.each(this.params.items,(e,i)=>{t.innerHTML+=this.getAddTypeMarkup(e,i)})})},getMenuSelector:t=>"#"+t.replace("boldgrid_menu_",""),getSidebarSelector:t=>"#"+t.replace("bgtfw_sidebar_",""),getAddTypeMarkup:(t,e)=>`<span class="bgtfw-sortable ${e}" data-key="${e}" aria-label="Add ${t.title}"><i class="fa fa-plus"></i>${t.title}</span>`,getCurrentItems(){return _.map(_.flatten(_.map(this.setting.get(),t=>_.values(t.items))),t=>t.type)},getAllSidebarLocations:()=>_.pluck(window._wpCustomizeWidgetsSettings.registeredSidebars,"id"),getAllSidebarActions(){return this.getAllSidebarLocations().map(t=>`bgtfw_sidebar_${t}`)},getFilteredSidebarActions(){return _.filter(this.getAllSidebarActions(),t=>t.includes(this.params.location))},getUsedSidebarActions(){return _.filter(this.getCurrentItems(),t=>t.includes("bgtfw_sidebar"))},getAvailableSidebars(){return _.difference(this.getFilteredSidebarActions(),this.getUsedSidebarActions())},getNextAvailableSidebar(){return _.first(this.getAvailableSidebars())},getNextAvailableAttribution(){return this.getCurrentItems().includes("boldgrid_display_attribution_links")?null:"boldgrid_display_attribution_links"},getAllMenuActions:()=>Object.keys(window._wpCustomizeNavMenusSettings.locationSlugMappedToName).map(t=>`boldgrid_menu_${t}`),getUsedMenuActions(){return _.filter(this.getCurrentItems(),t=>t.includes("boldgrid_menu"))},getAvailableMenus(){let t=this.getAllMenuActions();return t="sticky-header"===this.params.location?t.filter(t=>~t.indexOf("sticky")):t.filter(t=>!~t.indexOf("sticky")),_.difference(t,this.getConnectedMenus())},getNextAvailableMenu(){return _.first(this.getAvailableMenus())},getItem(t){switch(t){case"menu":t=this.getNextAvailableMenu();break;case"sidebar":t=this.getNextAvailableSidebar();break;case"branding":t="boldgrid_site_identity";break;case"attribution":t=this.getNextAvailableAttribution()}return t},getAttributionSettings:()=>_.filter(_.mapObject(window._wpCustomizeSettings.settings,(t,e)=>_.extend(t,{id:e})),t=>t.id.includes("hide_")&&t.id.includes("_attribution")),getConnectedControls(){return _.filter(window._wpCustomizeSettings.controls,{type:this.params.type})},getConnectedItems(){return _.flatten([].concat(_.map(this.getConnectedControls(),t=>this.id===t.id?this.getCurrentItems():_.isUndefined(api.control(t.id))?[]:api.control(t.id).getCurrentItems())))},getConnectedMenus(){let t=_.filter(this.getConnectedItems(),t=>t.includes("boldgrid_menu"));return!1!==api("bgtfw_fixed_header")()&&"header-top"===api("bgtfw_header_layout_position")()||(t=t.filter(t=>!t.includes("sticky"))),t},getLastConnected(){let t=_.last(this.getConnectedControls()).id;return _.isUndefined(api.control(t))?this:api.control(t)}};